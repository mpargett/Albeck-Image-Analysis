%IQ_EXCITATION_POWERMAP
%   Calibrated excitation source power (upstairs Albeck scope)

function pps = iq_excitation_powermap(fin, pct)

%Number of photons (n) may be calculated by the Planck-Einstein relation:
%   E = n*hc/l, where h = Planck's const(J-s), c = speed of light(m/s),
%       l = wavelength(m), n = number of photons, and E = energy(J)
%       and Power (pw) = E/s;

%Calibration table for Light Source output power (mW) to Percentage
pwc = [...
1,      5.5; ...
2,      31.1; ...
3,      43.8; ...
4,      62.5; ...
5,      75.7; ...
7,      111; ...
10,     167; ...
12,     204; ...
15,     263; ...
20,     352; ...
25,     443; ...
30,     533; ...
35,     618; ...
40,     696; ...
45,     776; ...
50,     853; ...
55,     928; ...
60,     995; ...
65,     1070; ...
70,     1140; ...
75,     1210; ...
80,     1270; ...
85,     1330; ...
90,     1390; ...
95,     1450; ...
100,    1500; ...
];

%Calibration table for power to stage through each Filter
%   Collected at 15% output power for all
%   ONLY FOR the 20x objective!
pts.Filter_DAPI = mean([3.25,3.64]);    pts.Filter_CFP = mean([4.36,4.72]);     
pts.Filter_GFP = mean([4.00,4.35]);     pts.Filter_YFP = mean([1.45,1.59]);     
pts.Filter_Cherry = mean([2.77,3.02]);  pts.Filter_Cy5 = mean([1.70,1.86]);
pts.Filter_Cherry2 = mean([2.77,3.02])*0.81;  %Assumed from Cherry spectra
%   Adjustment to ration of power-to-stage per power input
pts = structfun(@(x)x./pwc(pwc(:,1)==15, 2), pts, 'UniformOutput', false);

%Calibration table of mean Filter wavelength
mfw.Filter_DAPI = 354;      mfw.Filter_CFP = 435;     
mfw.Filter_GFP = 470;       mfw.Filter_YFP = 500;     
mfw.Filter_Cherry = 560;    mfw.Filter_Cy5 = 635;
mfw.Filter_Cherry2 = 575;
%   Adjustment to meters
mfw = structfun(@(x)x*10^-9, mfw, 'UniformOutput', false);


%Calculate Photons Per Second
for s = 1:numel(fin)  %FOR each relation requested
    pwr = interp1(pwc(:,1),pwc(:,2),pct(s),'linear','extrap') .* ...
                pts.(fin{s}).*10^-3; %Converted to Watts
    pps.(fin{s}) = pwr.*mfw.(fin{s}) ./ (6.62606957*10^-34 * 299792458);
end %                                    ^Planck's           ^Speed of Light        


end